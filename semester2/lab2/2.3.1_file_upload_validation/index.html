<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>2.3.1 File upload & validation - ITMO_ICT_WebDevelopment_2021-2022_sem_2</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">ITMO_ICT_WebDevelopment_2021-2022_sem_2</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../index2/" class="nav-link">Title</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../endpoints/endpoints/" class="nav-link">Api</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Semester 2 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Lab 1</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../lab1/1.1_containerization/" class="dropdown-item">1.1 Containerization</a>
</li>
            
<li>
    <a href="../../lab1/1.2_orchestration/" class="dropdown-item">1.2 Orchestration</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Lab 2</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../2.1.1_manual_filters/" class="dropdown-item">2.1.1 Manual filters</a>
</li>
            
<li>
    <a href="../2.1.2_auto_filters/" class="dropdown-item">2.1.2 Auto filters</a>
</li>
            
<li>
    <a href="../2.2.1_pagination/" class="dropdown-item">2.2.1 Pagination</a>
</li>
            
<li>
    <a href="../2.2.2_custom_pagination/" class="dropdown-item">2.2.2 Custom pagination</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">2.3.1 File upload & validation</a>
</li>
            
<li>
    <a href="../2.4.1_signals/" class="dropdown-item">2.4.1 Signals</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Lab 3</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../lab3/3.1.1_tests/" class="dropdown-item">3.1.1 Tests</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Lab 4</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../lab4/4.1.1_filters_interface/" class="dropdown-item">4.1.1 Filters interface</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../../index3/" class="nav-link">Conclusion</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../2.2.2_custom_pagination/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../2.4.1_signals/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            
            
            
            
            
            
            
            
            
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h4 id="231">Задание 2.3.1</h4>
<p>Реализовать следующие ендпоинты:</p>
<ul>
<li>Ендпоинт для загрузки файлов, с указанием внешнего ключа на связный объект и сохранением имени и размера файла в базе данных.</li>
<li>Ендпоинт для сохранения нескольких файлов и валидации на максимальный размер файла и доступные для загрузки расширения файлов.</li>
</ul>
<h3 id="-">Модель файла - изображения участника:</h3>
<pre><code class="language-python">class UploadAvatarClient(ViewSet):
    queryset = CleanerAvatar.objects.all()
    serializer_class = CleanerAvatarSerializer
    permission_classes = [IsAuthenticated]

    def create(self, request, *args, **kwargs):
        file_uploaded = request.FILES.get('file_uploaded')
        cleaner = request.POST.get('cleaner')
        content_type = file_uploaded.content_type
        file_name = file_uploaded.name
        file_size = file_uploaded.size
        serializer = self.serializer_class(data={&quot;file&quot;: file_uploaded, &quot;cleaner&quot;: cleaner, &quot;file_size&quot;: file_size})
        serializer.is_valid()
        serializer.save(file_name=file_name)
        response = f&quot;POST API and you have uploaded a {content_type} file {file_name}&quot;
        return Response(response)
</code></pre>
<h3 id="_1">Валидатор:</h3>
<pre><code class="language-python">@deconstructible
class FileValidator(object):
    error_messages = {
        'max_size': (&quot;Ensure this file size is not greater than %(max_size)s.&quot;
                     &quot; Your file size is %(size)s.&quot;),
        'min_size': (&quot;Ensure this file size is not less than %(min_size)s. &quot;
                     &quot;Your file size is %(size)s.&quot;),
        'content_type': &quot;Files of type %(content_type)s are not supported.&quot;,
    }

    def __init__(self, max_size=None, min_size=None, content_types=()):
        self.max_size = max_size
        self.min_size = min_size
        self.content_types = content_types

    def __call__(self, data):
        if self.max_size is not None and data.size &gt; self.max_size:
            params = {
                'max_size': filesizeformat(self.max_size),
                'size': filesizeformat(data.size),
            }
            raise ValidationError(self.error_messages['max_size'],
                                  'max_size', params)

        if self.min_size is not None and data.size &lt; self.min_size:
            params = {
                'min_size': filesizeformat(self.min_size),
                'size': filesizeformat(data.size)
            }
            raise ValidationError(self.error_messages['min_size'],
                                  'min_size', params)

        if self.content_types:
            content_type = magic.from_buffer(data.read(), mime=True)
            data.seek(0)

            if content_type not in self.content_types:
                params = {'content_type': content_type}
                raise ValidationError(self.error_messages['content_type'],
                                      'content_type', params)

    def __eq__(self, other):
        return (
                isinstance(other, FileValidator) and
                self.max_size == other.max_size and
                self.min_size == other.min_size and
                self.content_types == other.content_types
        )


file_validator = FileValidator(max_size=1024 * 100,
                               content_types=(&quot;image/jpeg&quot;,))


class FileUploads(models.Model):
    file = models.FileField(validators=[file_validator])
</code></pre>
<h3 id="_2">Сериализатор для аватара:</h3>
<pre><code class="language-python">class CleanerAvatarSerializer(ModelSerializer):
    file = serializers.FileField()

    class Meta:
        model = CleanerAvatar
        fields = ['file', 'cleaner', 'file_size']
</code></pre>
<h3 id="_3">Сериализатор для файлов:</h3>
<pre><code class="language-python">class FileUploadsSerializer(ModelSerializer):
    class Meta:
        model = FileUploads
        fields = ['file']
</code></pre>
<h3 id="_4">Вью для загрузки одного файла:</h3>
<pre><code class="language-python">class UploadAvatarClient(ViewSet):
    queryset = CleanerAvatar.objects.all()
    serializer_class = CleanerAvatarSerializer
    permission_classes = [IsAuthenticated]

    def create(self, request, *args, **kwargs):
        file_uploaded = request.FILES.get('file_uploaded')
        cleaner = request.POST.get('cleaner')
        content_type = file_uploaded.content_type
        file_name = file_uploaded.name
        file_size = file_uploaded.size
        serializer = self.serializer_class(data={&quot;file&quot;: file_uploaded, &quot;cleaner&quot;: cleaner, &quot;file_size&quot;: file_size})
        serializer.is_valid()
        serializer.save(file_name=file_name)
        response = f&quot;POST API and you have uploaded a {content_type} file {file_name}&quot;
        return Response(response)
</code></pre>
<h3 id="_5">Вью для нескольких файлов:</h3>
<pre><code class="language-python">class UploadFiles(ViewSet):
    queryset = CleanerAvatar.objects.all()
    serializer_class = FileUploadsSerializer
    permission_classes = [IsAuthenticated]

    def create(self, request):
        files = request.FILES.getlist('file')
        file_serializers = []
        for file in files:
            print(file)

            serializer = self.serializer_class(data={&quot;file&quot;: file})
            try:
                serializer.is_valid(raise_exception=True)
                file_serializers.append(serializer)
            except ValidationError as err:
                return HttpResponseBadRequest(err)

        for serializer in file_serializers:
            serializer.save()
        response = f&quot;POST API and yo
</code></pre>
<h3 id="_6">Загрузка одного файла:</h3>
<p><img alt="" src="../../imgs/avatar.jpg" /></p>
<h3 id="_7">Загрузка двух файлов:</h3>
<p><img alt="" src="../../imgs/success.png" /></p>
<p><img alt="" src="../../imgs/consol.jpg" /></p>
<h3 id="_8">Ошибки:</h3>
<p><img alt="" src="../../imgs/images1png.png" /></p>
<p><img alt="" src="../../imgs/images2.png" /></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
